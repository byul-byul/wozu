–í–æ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –±—É–¥—É—â–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ email-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:

---

### ‚úÖ **–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ `uuid`.
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (`is_used`).
* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ `refresh()` –ø–æ—Å–ª–µ commit.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `scalar_one_or_none()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –≤—ã–±–æ—Ä–æ–∫.

---

### üîß **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ:**

1. **–î–æ–±–∞–≤–∏—Ç—å TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞):**

   * –î–æ–±–∞–≤—å –ø–æ–ª–µ `expires_at` –≤ `EmailToken`.
   * –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–π `datetime.utcnow()` —Å `expires_at`.
   * –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π TTL: 15‚Äì30 –º–∏–Ω—É—Ç.

2. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `used_at`:**

   * –ü–æ–∑–≤–æ–ª–∏—Ç —Ç–æ—á–Ω–æ –≤–∏–¥–µ—Ç—å, –∫–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.
   * –£–¥–æ–±–Ω–æ –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

3. **–†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤:**

   * –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (cron –∏–ª–∏ Celery), –∫–æ—Ç–æ—Ä—ã–π —É–¥–∞–ª—è–µ—Ç:

     * –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (`expires_at < now`)
     * –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞—Ä—à–µ X –¥–Ω–µ–π.

4. **–ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤:**

   * –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `hmac` –∏–ª–∏ `itsdangerous` –≤–º–µ—Å—Ç–æ UUID.
   * –≠—Ç–æ –∑–∞—â–∏—Ç–∏—Ç –æ—Ç –ø–æ–¥–±–æ—Ä–∞/—É—Ç–µ—á–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤.

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `verify_email`:**

   * –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `"Already verified"`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ `is_active = True`.
   * –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç UX –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ.

6. **–î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–æ—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:**

   * –ß—Ç–æ–±—ã –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ —Å–ø–∞–º–∏—Ç—å `/register` –∏–ª–∏ `/resend`.
   * –ù–∞–ø—Ä–∏–º–µ—Ä: "–Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç".

---

–•–æ—á–µ—à—å ‚Äî –º–æ–≥—É –æ—Ñ–æ—Ä–º–∏—Ç—å —ç—Ç–æ –∫–∞–∫ `email_verification_hardening.md` –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ç–≤–æ–π `auth/README.md`.
